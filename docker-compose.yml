services:
  postgres:
    image: postgres:15-alpine
    container_name: vms_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: vms_cctv
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: vms_mediamtx
    ports:
      - "8554:8554"  # RTSP
      - "8888:8888"  # HTTP (HLS)
      - "8889:8889"  # HTTPS (HLS)
      - "9997:9997"  # API
      - "9998:9998"  # Metrics
    volumes:
      - ./mediamtx.yml:/mediamtx.yml:ro
    # MediaMTX uses mediamtx.yml as default, no need to specify
    restart: unless-stopped
    # Healthcheck disabled temporarily - MediaMTX is working but healthcheck command needs adjustment
    # healthcheck:
    #   test: ["CMD-SHELL", "exit 0"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 3

  api:
    build: .
    container_name: vms_api
    ports:
      - "8081:8080"
    environment:
      PORT: 8080
      GIN_MODE: release
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: vms_cctv
      DB_SSLMODE: disable
      JWT_SECRET: change-this-secret-in-production
      JWT_EXPIRY: 24h
      MEDIAMTX_HOST: mediamtx
      MEDIAMTX_PUBLIC_HOST: localhost
      MEDIAMTX_HTTP_PORT: 8888
      MEDIAMTX_API_PORT: 9997
    depends_on:
      postgres:
        condition: service_healthy
      mediamtx:
        condition: service_started
    restart: unless-stopped

volumes:
  postgres_data:

